# # Kubernetes Cluster with 1 Control Plane and 1 Worker
# # Using Ubuntu 22.04 + kubeadm + containerd

# Vagrant.configure("2") do |config|
#     # Base image
#     config.vm.box = "ubuntu/jammy64"
  
#     # Disable synced folder (faster)
#     config.vm.synced_folder ".", "/vagrant", disabled: true
  
#     # Common provisioning script for all nodes
#     COMMON_SCRIPT = <<-SCRIPT
#       # Disable swap
#       sudo sed -i '/swap/d' /etc/fstab
#       sudo swapoff -a
  
#       # Load required modules
#       sudo modprobe overlay
#       sudo modprobe br_netfilter
  
#       cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
#       net.bridge.bridge-nf-call-iptables  = 1
#       net.bridge.bridge-nf-call-ip6tables = 1
#       net.ipv4.ip_forward                 = 1
#       EOF
  
#       sudo sysctl --system
  
#       # Install containerd
#       sudo apt-get update -y
#       sudo apt-get install -y containerd apt-transport-https ca-certificates curl
  
#       sudo mkdir -p /etc/containerd
#       sudo containerd config default | sudo tee /etc/containerd/config.toml
  
#       sudo systemctl restart containerd
#       sudo systemctl enable containerd
  
#       # Install Kubernetes (kubeadm, kubelet, kubectl)
#       sudo curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | sudo gpg --dearmor -o /usr/share/keyrings/kubernetes-archive-keyring.gpg
#       echo "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /" | sudo tee /etc/apt/sources.list.d/kubernetes.list
  
#       sudo apt-get update -y
#       sudo apt-get install -y kubelet kubeadm kubectl
#       sudo apt-mark hold kubelet kubeadm kubectl
#     SCRIPT
  
#     # ---------------------------------------
#     # CONTROL PLANE NODE
#     # ---------------------------------------
#     config.vm.define "master" do |master|
#       master.vm.hostname = "master"
#       master.vm.network "private_network", ip: "192.168.56.10"
  
#       master.vm.provider "virtualbox" do |vb|
#         vb.name = "k8s-master"
#         vb.memory = 4096
#         vb.cpus = 2
#       end
  
#       master.vm.provision "shell", inline: COMMON_SCRIPT
  
#       # Initialize the cluster on the master node
#       master.vm.provision "shell", inline: <<-SCRIPT
#         sudo kubeadm init --apiserver-advertise-address=192.168.56.10 --pod-network-cidr=10.244.0.0/16
  
#         mkdir -p $HOME/.kube
#         sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
#         sudo chown $(id -u):$(id -g) $HOME/.kube/config
  
#         # Install Flannel CNI
#         kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
  
#         # Save join command for workers
#         kubeadm token create --print-join-command > /vagrant/join.sh
#       SCRIPT
#     end
  
#     # ---------------------------------------
#     # WORKER NODE
#     # ---------------------------------------
#     config.vm.define "worker1" do |worker|
#       worker.vm.hostname = "worker1"
#       worker.vm.network "private_network", ip: "192.168.56.11"
  
#       worker.vm.provider "virtualbox" do |vb|
#         vb.name = "k8s-worker1"
#         vb.memory = 4096
#         vb.cpus = 2
#       end
  
#       worker.vm.provision "shell", inline: COMMON_SCRIPT
  
#       # Join the cluster
#       worker.vm.provision "shell", inline: <<-SCRIPT, run: "always"
#         bash /vagrant/join.sh
#       SCRIPT
#     end
#   end
  




# Two Node cluster Vagrantfile
Vagrant.configure("2") do |config|
    config.vm.box = "ubuntu/jammy64"
  
    # Disable synced folder to avoid performance issues
    config.vm.synced_folder ".", "/vagrant", disabled: true
  
    # ---------------------------------------
    # CONTROL NODE
    # ---------------------------------------
    config.vm.define "master" do |master|
      master.vm.hostname = "master"
      master.vm.network "private_network", ip: "192.168.56.10"
  
      master.vm.provider "virtualbox" do |vb|
        vb.name = "master-node"
        vb.memory = 4096
        vb.cpus = 4
      end
    end
  
    # ---------------------------------------
    # WORKER NODE
    # ---------------------------------------
    config.vm.define "worker1" do |worker|
      worker.vm.hostname = "worker1"
      worker.vm.network "private_network", ip: "192.168.56.11"
  
      worker.vm.provider "virtualbox" do |vb|
        vb.name = "worker-node-1"
        vb.memory = 4096
        vb.cpus = 4
      end
    end
  end
  